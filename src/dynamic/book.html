<table style="margin: 0 auto; padding: 20px; text-align: center;"></table>
<div style="margin: 0 auto; padding: 20px; width: 50%;">
	<div class="panel">
		<label>Name: <input id="inp-name" type="text"></label><br>
		<label>Email: <input id="inp-email" type="text"></label><br>
		<label>Phone: <input id="inp-phone" type="text"></label>
	</div><!--
	--><div class="panel">
		<button onclick="makeBooking();">Book Now</button>
	</div>
</div>
<script>
document.title = "SPX - Booking";

// fill out seats from database
let alpha = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
for (let y = 0; y < 9; y++)
{
	let tr = document.createElement("tr");
	for (let x = 0; x < 15; x++)
	{
		let td = document.createElement("td");
		td.id = "seat-"+alpha[y]+"-"+String(x);
		td.className = "seat";
		td.setAttribute("data-chosen","false");
		td.setAttribute("data-full","false");
		//if (Math.random() < 0.5) td.setAttribute("data-full","true");
		td.addEventListener("click",function(ev){
			if (td.getAttribute("data-full") === "true") return;
			if (td.getAttribute("data-chosen") === "false")
				td.setAttribute("data-chosen","true");
			else
				td.setAttribute("data-chosen","false");
		});
        td.textContent = alpha[y]+String(x);
		tr.appendChild(td);
	}
	document.body.getElementsByTagName("table")[0].appendChild(tr);
}

(async()=>{
	let bookings = await api( "bookings" + queryString() );
	for (let booking of bookings)
	{
		for (let seat of booking["bookingSeats"])
		{
			document.getElementById("seat-"+seat).setAttribute("data-full","true");
		}
	}
})();

function makeBooking()
{
	let booking = {
		"bookingId": 0,
		"sessionId": Number(new URL(document.URL).searchParams.get("sessionId")),
		"bookingSeats": [],
		"bookingName": document.getElementById("inp-name").value,
		"bookingPhone": document.getElementById("inp-email").value,
		"bookingEmail": document.getElementById("inp-phone").value,
		"bookingCode": "",
		"bookingDate": ""
	}
	for (let seat of document.getElementsByClassName("seat"))
	{
		if (seat.getAttribute("data-chosen") === "true") booking["bookingSeats"].push(seat.id.slice(5));
	}
	if (booking["bookingSeats"].length > 0)
	{
		api("reserve",booking).then(v=>{
			console.log(v["bookingCode"]);
			window.location.assign("/view?bookingCode="+encodeURIComponent(v["bookingCode"]));
		});
	}
	else
	{
		alert("Please choose some seats first.")
	}
}
</script>